# yaml-language-server: $schema=../../../../blueprints/policies/service-protection-with-load-based-pod-auto-scaler/average-latency/gen/definitions.json
policy:
  policy_name: auto-scaling-hasura
  auto_scaling:
    kubernetes_replicas:
      max_replicas: "10"
      min_replicas: "1"
      kubernetes_object_selector:
        agent_group: default
        api_version: apps/v1
        kind: Deployment
        name: hasura
        namespace: cloud
    scaling_parameters:
      scale_in_cooldown: "120s"
      scale_out_cooldown: "30s"
  resources:
    flow_control:
      classifiers:
        - selectors:
            - service: hasura.cloud.svc.cluster.local
              control_point: ingress
          rego:
            labels:
              source:
                telemetry: true
              operation:
                telemetry: true
            module: |
              package hasura_example
              source = input.attributes.source.source_fqdns[0]
              operation = graphql.parse_query(input.parsed_body.query).Operations[_].Operation
  service_protection_core:
    dry_run: true
    adaptive_load_scheduler:
      load_scheduler:
        selectors:
          - control_point: ingress
            service: hasura.cloud.svc.cluster.local
        scheduler:
          workloads:
            - label_matcher:
                match_labels:
                  source: "api-service.cloud.svc.cluster.local"
              parameters:
                priority: 200
              name: "api-service"
            - label_matcher:
                match_labels:
                  source: "agent-service.cloud.svc.cluster.local"
                  operation: "mutation"
              parameters:
                priority: 100
              name: "agent-service-mutation"
            - label_matcher:
                match_labels:
                  source: "agent-service.cloud.svc.cluster.local"
                  operation: "query"
              parameters:
                priority: 50
              name: "agent-service-query"
  latency_baseliner:
    flux_meter:
      selectors:
        - control_point: ingress
          service: hasura.cloud.svc.cluster.local
          label_matcher:
            match_labels:
              operation: "query"
              source: "api-service.cloud.svc.cluster.local"
