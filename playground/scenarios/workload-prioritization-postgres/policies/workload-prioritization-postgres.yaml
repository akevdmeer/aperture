# yaml-language-server: $schema=../../../../blueprints/policies/service-protection/promql/gen/definitions.json
policy:
  policy_name: workload-prioritization-postgres
  promql_query: '(sum(postgresql_backends) / sum(postgresql_connection_max)) * 100'
  setpoint: 70
  evaluation_interval: "1s"
  resources:
    flow_control:
      classifiers:
        - selectors:
            - service: hasura.cloud.svc.cluster.local
              control_point: ingress
          rego:
            labels:
              source:
                telemetry: true
              operation:
                telemetry: true
            module: |
              package hasura_example
              source = input.attributes.source.source_fqdns[0]
              operation = graphql.parse_query(input.parsed_body.query).Operations[_].Operation
    telemetry_collectors:
      - agent_group: default
        infra_meters:
          postgresql:
            per_agent_group: true
            receivers:
              postgresql:
                endpoint: hasura-postgresql.cloud.svc.cluster.local:5432
                username: postgres
                password: DevPassword
                collection_interval: 1s
                tls:
                  insecure: true
  service_protection_core:
    overload_confirmations:
      - query_string: 'max(k8s_pod_cpu_utilization_ratio{k8s_statefulset_name="hasura-postgresql"})'
        threshold: 2.1
        operator: gte
    adaptive_load_scheduler:
      load_scheduler:
        selectors:
          - control_point: ingress
            service: hasura.cloud.svc.cluster.local
        scheduler:
          workloads:
            - label_matcher:
                match_labels:
                  source: "api-service.cloud.svc.cluster.local"
              parameters:
                priority: 255
              name: "api-service"
            - label_matcher:
                match_labels:
                  source: "agent-service.cloud.svc.cluster.local"
                  operation: "mutation"
              parameters:
                priority: 100
              name: "agent-service-mutation"
            - label_matcher:
                match_labels:
                  source: "agent-service.cloud.svc.cluster.local"
                  operation: "query"
              parameters:
                priority: 50
              name: "agent-service-query"
