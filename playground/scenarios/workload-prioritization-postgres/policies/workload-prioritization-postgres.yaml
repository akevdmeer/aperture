# yaml-language-server: $schema=../../../../blueprints/policies/service-protection/promql/gen/definitions.json
policy:
  policy_name: workload-prioritization-postgres
  promql_query: 'sum(pg_connections{db="hasura"}) / max(pg_setting{name="max_connections"}) * 100'
  setpoint: 70
  evaluation_interval: "1s"
  resources:
    flow_control:
      classifiers:
        - selectors:
            - service: hasura.cloud.svc.cluster.local
              control_point: ingress
          rego:
            labels:
              source:
                telemetry: true
              operation:
                telemetry: true
            module: |
              package hasura_example
              source = input.attributes.source.source_fqdns[0]
              operation = graphql.parse_query(input.parsed_body.query).Operations[_].Operation
    telemetry_collectors:
      - agent_group: default
        infra_meters:
          prometheus_simple:
            per_agent_group: true
            receivers:
              prometheus_simple:
                collection_interval: 1s
                use_service_account: true
                endpoint: "hasura-postgresql-metrics.cloud.svc.cluster.local:9187"
                tls:
                  insecure_skip_verify: true
  service_protection_core:
    adaptive_load_scheduler:
      load_scheduler:
        selectors:
          - control_point: ingress
            service: hasura.cloud.svc.cluster.local
        scheduler:
          workloads:
            - label_matcher:
                match_labels:
                  source: "api-service.cloud.svc.cluster.local"
              parameters:
                priority: 200
              name: "api-service"
            - label_matcher:
                match_labels:
                  source: "agent-service.cloud.svc.cluster.local"
                  operation: "mutation"
              parameters:
                priority: 100
              name: "agent-service-mutation"
            - label_matcher:
                match_labels:
                  source: "agent-service.cloud.svc.cluster.local"
                  operation: "query"
              parameters:
                priority: 50
              name: "agent-service-query"
